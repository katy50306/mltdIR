<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>偶像別排名log</title>
	<link rel="stylesheet" href="https://unpkg.com/bootstrap@5.3.0/dist/css/bootstrap.min.css">
	<link rel="stylesheet" href="https://unpkg.com/select2@4.0.13/dist/css/select2.min.css">
	<link rel="stylesheet" href="https://unpkg.com/tabulator-tables@5.5.0/dist/css/tabulator_bootstrap5.min.css">
	<style>
		.cw {
			width: 250px;
		}
	</style>
	<base target="_blank">
</head>
 
<body>
	<div class="container mt-5">
		<p>資料來源(Data Source)：<a href='https://api.matsurihi.me/docs/'>Princess (Public REST API)</a> - from <a href='https://www.matsurihi.me/'>matsurihi.me</a></p>
		<p>程式碼更新時間：<span id="timeUpdate"></span>&emsp;<a data-bs-toggle="collapse" href="#news">更新紀錄</a>&emsp;<a href="mltdIR.html" download>下載原始碼</a>&emsp;<a href="https://github.com/katy50306/mltdIR/">github</a></p>
		
		<!--更新紀錄-->
		<div class="collapse" id="news">
			<div class="card card-body" id="news-detail"></div>
		</div>
	</div>
	
	<div class="container my-1">
		<form>
			<div class="form-group row">
			  <label for="idolID" class="col-sm-2 col-form-label">偶像</label>
			  <div class="col-sm-10">
				<select id="idolId" class="select2 cw" name="idolId"></select>
			  </div>
			</div>

			<div class="form-group row my-2">
			  <label for="rank" class="col-sm-2 col-form-label">名次</label>
			  <div class="col-sm-10">
				<input type="text" class="form-control cw" id="rank" placeholder="例: 1-10,15,20">
			  </div>
			</div>

			<div class="form-group row my-2">
				<label for="time" class="col-sm-2 col-form-label">從何時起(你的時區)</label>
				<div class="col-sm-10">
				  <input type="datetime-local" class="form-control cw" id="time">
				</div>
			</div>

			<div class="form-group row my-2">
				<label class="col-sm-2 col-form-label">資料間隔</label>
				<div class="col-sm-10">
					<span class="btn-group" role="group">
						<input type="radio" class="btn-check" name="all" id="time1" value="false" checked>
						<label class="btn btn-outline-primary" for="time1">30分</label>
						<input type="radio" class="btn-check" name="all" id="time2" value="true">
						<label class="btn btn-outline-primary" for="time2">&nbsp;5分</label>
					</span>
				</div>
			</div>
		</form>

		<div class="form-group row my-2">
			<label class="col-sm-2"></label>
			<div class="col-sm-10">
				<button id="update" class="btn btn-primary">抓資料</button>
			</div>
		</div>

	</div>

	<hr>

	<div class="container my-1">
		<p>Chart</p>
		<div id="mc" style="width:100%; height:400px;"></div>
	</div>
	
	<hr>
	
	<div class="container mb-5">
		<p>Data</p>
		<button id="download-csv" class="btn btn-primary data">下載CSV</button>
		<span>&emsp;&emsp;PT差異計算</span>
		<button id="columnDiff" class="btn btn-primary data">不同名次</button>
		<button id="rowDiff" class="btn btn-primary data">同名次</button>
		<div id="table" class="mt-2"></div>
	</div>
	

	<script src='https://unpkg.com/jquery@3.7.0/dist/jquery.min.js'></script>
	<script src='https://unpkg.com/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js'></script>
	<script src="https://code.highcharts.com/highcharts.js"></script>
	<script src="https://unpkg.com/dayjs@1.11.9/dayjs.min.js"></script>
	<script src="https://unpkg.com/select2@4.0.13/dist/js/select2.full.min.js"></script>
	<script src="https://unpkg.com/tabulator-tables@5.5.0/dist/js/tabulator.min.js"></script>
	<script src="https://unpkg.com/marked@5.1.1/marked.min.js"></script>

	<script>
	$(()=>{

		const idol=[
			{id:1,text:'1.天海 春香'},
			{id:2,text:'2.如月 千早'},
			{id:3,text:'3.星井 美希'},
			{id:4,text:'4.萩原 雪歩'},
			{id:5,text:'5.高槻 やよい'},
			{id:6,text:'6.菊地 真'},
			{id:7,text:'7.水瀬 伊織'},
			{id:8,text:'8.四条 貴音'},
			{id:9,text:'9.秋月 律子'},
			{id:10,text:'10.三浦 あずさ'},
			{id:11,text:'11.双海 亜美'},
			{id:12,text:'12.双海 真美'},
			{id:13,text:'13.我那覇 響'},
			{id:14,text:'14.春日 未来'},
			{id:15,text:'15.最上 静香'},
			{id:16,text:'16.伊吹 翼'},
			{id:17,text:'17.田中 琴葉'},
			{id:18,text:'18.島原 エレナ'},
			{id:19,text:'19.佐竹 美奈子'},
			{id:20,text:'20.所 恵美'},
			{id:21,text:'21.徳川 まつり'},
			{id:22,text:'22.箱崎 星梨花'},
			{id:23,text:'23.野々原 茜'},
			{id:24,text:'24.望月 杏奈'},
			{id:25,text:'25.ロコ'},
			{id:26,text:'26.七尾 百合子'},
			{id:27,text:'27.高山 紗代子'},
			{id:28,text:'28.松田 亜利沙'},
			{id:29,text:'29.高坂 海美'},
			{id:30,text:'30.中谷 育'},
			{id:31,text:'31.天空橋 朋花'},
			{id:32,text:'32.エミリー スチュアート'},
			{id:33,text:'33.北沢 志保'},
			{id:34,text:'34.舞浜 歩'},
			{id:35,text:'35.木下 ひなた'},
			{id:36,text:'36.矢吹 可奈'},
			{id:37,text:'37.横山 奈緒'},
			{id:38,text:'38.二階堂 千鶴'},
			{id:39,text:'39.馬場 このみ'},
			{id:40,text:'40.大神 環'},
			{id:41,text:'41.豊川 風花'},
			{id:42,text:'42.宮尾 美也'},
			{id:43,text:'43.福田 のり子'},
			{id:44,text:'44.真壁 瑞希'},
			{id:45,text:'45.篠宮 可憐'},
			{id:46,text:'46.百瀬 莉緒'},
			{id:47,text:'47.永吉 昴'},
			{id:48,text:'48.北上 麗花'},
			{id:49,text:'49.周防 桃子'},
			{id:50,text:'50.ジュリア'},
			{id:51,text:'51.白石 紬'},
			{id:52,text:'52.桜守 歌織'}
		];

		$(".data").attr('disabled', true)
		//代預設值
		$("#idolId").select2({data:idol}).val(localStorage.getItem("idolId")).trigger('change')
		$("#time").val(localStorage.getItem("time") === null ? dayjs().subtract(12, 'h').format('YYYY-MM-DDTHH:00'):localStorage.getItem("time"))
		$("#rank").val(localStorage.getItem("rank"))

		const chart = Highcharts.chart('mc', {
            chart: {
                zoomType: 'x'
            },
            title: {
                text: ''
            },
			legend: {
				itemStyle: {
					fontSize: '20px'
				}
			},
			yAxis: {
				labels: {
					formatter: function() {
						return Highcharts.numberFormat(this.value, 0, ',', ',');
					}
				}
			},
        });
		
		var table = new Tabulator("#table", {
			height:'500px',
			autoColumns:true,
		});
		
		$("#download-csv").on("click", ()=>{
			table.download("csv", "data.csv", {bom:true})
		});
		
		$('#columnDiff').on('click', ()=>{
			columnDiff()
		})

		$('#rowDiff').on('click', ()=>{
			rowDiff()
		})
		
		$('#update').on('click', ()=>{
			const idolId = $('#idolId').select2('data')[0].id
			const rank = $('#rank').val()
			if(rank===''){
				alert('未填排名')
				throw new Error("未填排名"); 
			}
			const since = dayjs($('#time').val()).subtract(1, 's').toISOString()	//原始不含該點故-1s
			const all = $('input[name=all]:checked').val()
			const url = "https://api.matsurihi.me/api/mltd/v2/events/290/rankings/idolPoint/" + idolId + "/logs/" + rank + '?prettyPrint=false&since=' + since + '&all=' + all ;
			
			//儲存變數，下次進入時代入
			localStorage.setItem("idolId", idolId)
			localStorage.setItem("rank", rank)
			localStorage.setItem("time", dayjs($('#time').val()).format('YYYY-MM-DDTHH:00'))

			$.getJSON( url, (d) => {
				
			}).done((d)=>{
				//30分的資料過濾出5分的
				let df = (all==='true'?d:filterData(d))
				let dp= dataProcess(df)
				draw(dp)
            	setTable(dp)
				$(".data").attr('disabled', false)
			}).fail((jqXHR, textStatus, errorThrown)=>{
				alert('錯誤')
			})//end getJSON
		})

		function filterData(d){
			let r=[]
			//處理30分最後一天含5分資料
			let t1 = Object.values(d).map(e1=>{
				let r2 = Object.values(e1.data).filter(e2=>{
					if((dayjs(e2.aggregatedAt).format('mm') === '00' || dayjs(e2.aggregatedAt).format('mm') === '30')){
						return e2
					}
				})
				r.push({'rank':e1.rank, 'data':r2})
			})
			console.log('filter')
			return r
		}


		function dataProcess(dp){
            
			var s=[] //分數
			
            let t=dp[0].data.map(e=>dayjs(e.aggregatedAt).format('MM/DD HH:mmZZ')) //取時間
            r=dp.map(e=>'rank'+e.rank)  //取排名
            dp.map((e,i)=>{ //取分數
                s[i] = e.data.map(e=>e.score)
            })  
			console.log('dataProcess')
            return {time: t, rank:r, score:s}

        }//end dataProcess


		function draw(a){

			//清舊資料
			while (chart.series.length > 0) {
				chart.series[0].remove();
			}

			//加新資料
			chart.xAxis[0].update({
				categories: a.time
			})

			for (let i=0; i<a.rank.length; i++){
				chart.addSeries({
					lineWidth: 3,
					name:a.rank[i],
					data:a.score[i]
				}, false)
			}
			chart.redraw()
		}


        function setTable(a){
            
			//組合
			var tData=[]
			var temp={}
			
			for (let j=0 ; j<a.time.length; j++ ) {
				
				for (let i=0 ; i<a.rank.length; i++ ) {
					temp = Object.assign({}, temp, {[a.rank[i]]: a.score[i][j]})
				}
				
				tData.push(Object.assign({}, {aggregatedAt:a.time[j]} , temp))
			}

			table.setData(tData)
            
        }
		
		
		async function columnDiff(){
			//計算排名間差異
			
			var ds = table.getData()	//取回資料
			var td = table.getColumnDefinitions()	//取得column資訊
			var c = td.length //先固定size
			
			let r = await columnCal(c, td, ds)
			
			table.setData(r)
			
		}//end columnDiff
		

		function columnCal(c, td, ds){
			//計算排名間pt差
			
			let d = Object.values(ds)
			var dc = []
			
			d.forEach((e)=> {
				//計算單row的diff資料
				for (var i = 1; i< c-1; i++){
					let n = td[i].field + '-' + td[i+1].field
					e = Object.assign({}, e, { [n] : e[td[i].field] - e[td[i+1].field] })
				}
				dc.push(e)
			})
			
			return dc
			
		}//end columnCal
		

		async function rowDiff(){

			var ds = table.getData()	//取回資料
			//計算同排名時間pt差
            var a=[]    //存放array化的data [time, r1, r2, ...]
            var t=[]    //存key

            t=(Object.keys(ds[0]))    //抓title

            ds.forEach((v)=>{ //抓data
                a.push(Object.values(Object.values(v)))
            })

            //改title
            var tc=t.length  //先存個數
            for (let i=1; i<tc; i++){    //0是時間不抓
                t.push('Δ'+t[i])
            }

            var b=[]//存放差的資料資料
            //計算差異
            var dc=a.length  //先存個數
            
            for (var i=0; i<dc;i++){
                b[i] = await rowDiffCal(a,i,tc,t)
            }

            table.setData(b)
		
		}//end rowDiff


        function rowDiffCal(a, i, tc, t){
            //計算同排名前後時間的pt差
            var v = []
            for (let j=1;j<tc;j++){
                    if (i==0){
                        v[j-1] = 0
                    }
                    else{
                        v[j-1] = a[i][j] - a[i-1][j]
                    }
                }
            
            //合併資料&轉物件
            return Object.fromEntries(t.map((key, index) => [key, a[i].concat(v)[index]]))

        }
		
		//更新log
		const news=`
		# 2023/7/12
		1. 30分最後一天變5分問題(原設計)，暫時修正，待後續再研究有無好解法
		2. url query加入prettyPrint=false

		# 2023/7/8
		1. 修正外部連結之連結方式
		2. 填資料部分改以bootstrap的grid方式處理
		3. 用localStorage儲存所選偶像、名次、時間，減少重整後再輸入問題
		4. 新增更新log
		
		# 2023/7/7
		1. 改按鈕位置
		2. 資料間隔由選單變為radio
		3. 改以highchart表現
		4. 時間查詢內部減1秒以呈現選定時間點的資料
		
		# 2023/7/6
		1. 拆分取資料及將資料引入table的function
		2. 修正圖表名次數由多變少時，多的那些仍留著的bug
		
		# 2023/7/5
		新增計算同名次不同時間pt差
		
		# 2023/7/2
		新增計算不同名次間的pt差異
		
		# 2023/7/1
		新增table，展示各名次pt 
		
		# 2023/6/30
		初版，僅繪圖
		`
    	$('#news-detail').html(marked.parse(news))
		$('#timeUpdate').text('2023-07-12 10:21:48')

	})//end ready
	</script>
</body>
</html>